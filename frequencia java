document.addEventListener('DOMContentLoaded', function() {
    // Initialize SQL.js database
    let db;
    const initSqlJs = window.initSqlJs;
    const config = {
        locateFile: filename => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${filename}`
    };

    // Initialize database and create table
    initSqlJs(config).then(function(SQL) {
        db = new SQL.Database();
        
        // Create the movimento_mes table if it doesn't exist
        db.run(`
            CREATE TABLE if not exists movimento_mes (
                id_movimento INTEGER primary key AUTOINCREMENT,
                cliente varchar(50) not NULL,
                treinos_feitos varchar(10) NOT NULL,
                faltas varchar(10) NOT NULL 
            );
        `);
        
        // Check if sample data exists
        const result = db.exec("SELECT COUNT(*) as count FROM movimento_mes");
        if (result[0].values[0][0] === 0) {
            db.run(
                "INSERT INTO movimento_mes (cliente, treinos_feitos, faltas) VALUES (?, ?, ?)",
                ['mariana', '44', '122']
            );
        }
        
        // Load initial data
        loadData();
    }).catch(function(error) {
        console.error("Error initializing database:", error);
        alert("Erro ao inicializar o banco de dados. Recarregue a página.");
    });

    // DOM elements
    const form = document.getElementById('frequenciaForm');
    const btnIncluir = document.getElementById('btnIncluir');
    const btnExcluir = document.getElementById('btnExcluir');
    const btnAlterar = document.getElementById('btnAlterar');
    const btnConsultar = document.getElementById('btnConsultar');
    const btnVoltar = document.querySelector('.botao5');
    const tabelaCorpo = document.getElementById('tabelaCorpo');

    // Event listeners
    btnIncluir.addEventListener('click', incluirRegistro);
    btnExcluir.addEventListener('click', excluirRegistro);
    btnAlterar.addEventListener('click', alterarRegistro);
    btnConsultar.addEventListener('click', consultarRegistro);
    btnVoltar.addEventListener('click', function(e) {
        e.preventDefault();
        window.location.href = 'escolha.html';
    });

    // Function to load and display data
    function loadData() {
        if (!db) return;
        
        try {
            const result = db.exec("SELECT * FROM movimento_mes");
            tabelaCorpo.innerHTML = '';
            
            if (result.length > 0 && result[0].values.length > 0) {
                result[0].values.forEach(row => {
                    const tr = document.createElement('tr');
                    tr.dataset.id = row[0]; // Store ID in data attribute
                    
                    // ID column
                    const tdId = document.createElement('td');
                    tdId.textContent = row[0];
                    tr.appendChild(tdId);
                    
                    // Cliente column
                    const tdCliente = document.createElement('td');
                    tdCliente.textContent = row[1];
                    tr.appendChild(tdCliente);
                    
                    // Treinos column
                    const tdTreinos = document.createElement('td');
                    tdTreinos.textContent = row[2];
                    tr.appendChild(tdTreinos);
                    
                    // Faltas column
                    const tdFaltas = document.createElement('td');
                    tdFaltas.textContent = row[3];
                    tr.appendChild(tdFaltas);
                    
                    // Action buttons column
                    const tdActions = document.createElement('td');
                    
                    // Edit button
                    const editBtn = document.createElement('button');
                    editBtn.textContent = 'Editar';
                    editBtn.className = 'btn-editar';
                    editBtn.addEventListener('click', () => carregarParaEdicao(row[0]));
                    
                    // Delete button
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'Excluir';
                    deleteBtn.className = 'btn-excluir';
                    deleteBtn.addEventListener('click', () => confirmarExclusao(row[0]));
                    
                    tdActions.appendChild(editBtn);
                    tdActions.appendChild(deleteBtn);
                    tr.appendChild(tdActions);
                    
                    tabelaCorpo.appendChild(tr);
                });
            }
        } catch (error) {
            console.error("Error loading data:", error);
            alert("Erro ao carregar os dados da tabela.");
        }
    }

    // Load record for editing
    function carregarParaEdicao(id) {
        if (!db) return;
        
        try {
            const result = db.exec("SELECT * FROM movimento_mes WHERE id_movimento = ?", [id]);
            
            if (result.length > 0 && result[0].values.length > 0) {
                const registro = result[0].values[0];
                
                document.getElementById('codigo').value = registro[0]; // ID
                document.getElementById('cliente').value = registro[1]; // cliente
                document.getElementById('treinos').value = registro[2]; // treinos
                document.getElementById('faltas').value = registro[3]; // faltas
                
                // Scroll to form
                form.scrollIntoView({ behavior: 'smooth' });
            }
        } catch (error) {
            console.error("Error loading record:", error);
            alert("Erro ao carregar registro para edição.");
        }
    }

    // Confirm deletion
    function confirmarExclusao(id) {
        if (confirm('Tem certeza que deseja excluir este registro?')) {
            excluirPorId(id);
        }
    }

    // Delete by ID
    function excluirPorId(id) {
        if (!db) return;
        
        try {
            db.run("DELETE FROM movimento_mes WHERE id_movimento = ?", [id]);
            loadData();
            alert('Registro excluído com sucesso!');
            form.reset();
        } catch (error) {
            console.error("Error deleting record:", error);
            alert("Erro ao excluir registro.");
        }
    }

    // Include new record
    function incluirRegistro(e) {
        e.preventDefault();
        if (!db) return;
        
        const codigo = document.getElementById('codigo').value;
        const cliente = document.getElementById('cliente').value;
        const treinos = document.getElementById('treinos').value;
        const faltas = document.getElementById('faltas').value;
        
        if (!cliente || !treinos || !faltas) {
            alert('Preencha todos os campos obrigatórios!');
            return;
        }
        
        try {
            if (codigo) {
                // Update existing record
                db.run(
                    "UPDATE movimento_mes SET cliente = ?, treinos_feitos = ?, faltas = ? WHERE id_movimento = ?",
                    [cliente, treinos, faltas, codigo]
                );
                alert('Registro atualizado com sucesso!');
            } else {
                // Insert new record
                db.run(
                    "INSERT INTO movimento_mes (cliente, treinos_feitos, faltas) VALUES (?, ?, ?)",
                    [cliente, treinos, faltas]
                );
                alert('Registro incluído com sucesso!');
            }
            
            form.reset();
            loadData();
        } catch (error) {
            console.error("Error saving record:", error);
            alert('Erro ao salvar registro: ' + error.message);
        }
    }

    // Delete record
    function excluirRegistro(e) {
        e.preventDefault();
        if (!db) return;
        
        const codigo = document.getElementById('codigo').value;
        
        if (!codigo) {
            alert('Selecione um registro para excluir (use o botão Excluir na tabela)');
            return;
        }
        
        confirmarExclusao(codigo);
    }

    // Update record
    function alterarRegistro(e) {
        e.preventDefault();
        incluirRegistro(e); // Uses same logic as include for update
    }

    // Query record
    function consultarRegistro(e) {
        e.preventDefault();
        if (!db) return;
        
        const cliente = document.getElementById('cliente').value;
        
        if (!cliente) {
            alert('Informe o nome do cliente para consultar!');
            return;
        }
        
        try {
            const result = db.exec("SELECT * FROM movimento_mes WHERE cliente LIKE ?", [`%${cliente}%`]);
            tabelaCorpo.innerHTML = '';
            
            if (result.length > 0 && result[0].values.length > 0) {
                result[0].values.forEach(row => {
                    const tr = document.createElement('tr');
                    
                    // ID column
                    const tdId = document.createElement('td');
                    tdId.textContent = row[0];
                    tr.appendChild(tdId);
                    
                    // Cliente column
                    const tdCliente = document.createElement('td');
                    tdCliente.textContent = row[1];
                    tr.appendChild(tdCliente);
                    
                    // Treinos column
                    const tdTreinos = document.createElement('td');
                    tdTreinos.textContent = row[2];
                    tr.appendChild(tdTreinos);
                    
                    // Faltas column
                    const tdFaltas = document.createElement('td');
                    tdFaltas.textContent = row[3];
                    tr.appendChild(tdFaltas);
                    
                    // Action buttons column
                    const tdActions = document.createElement('td');
                    
                    // Edit button
                    const editBtn = document.createElement('button');
                    editBtn.textContent = 'Editar';
                    editBtn.className = 'btn-editar';
                    editBtn.addEventListener('click', () => carregarParaEdicao(row[0]));
                    
                    // Delete button
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'Excluir';
                    deleteBtn.className = 'btn-excluir';
                    deleteBtn.addEventListener('click', () => confirmarExclusao(row[0]));
                    
                    tdActions.appendChild(editBtn);
                    tdActions.appendChild(deleteBtn);
                    tr.appendChild(tdActions);
                    
                    tabelaCorpo.appendChild(tr);
                });
            } else {
                alert('Nenhum registro encontrado para este cliente!');
                loadData(); // Reload all data
            }
        } catch (error) {
            console.error("Error querying data:", error);
            alert("Erro ao consultar registros.");
        }
    }
});

// Add this CSS to your frequencia.css file
const additionalCSS = `
/* Add these styles to your existing frequencia.css */
.btn-editar, .btn-excluir {
    padding: 5px 10px;
    margin: 0 3px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
}

.btn-editar {
    background-color: #4CAF50;
    color: white;
}

.btn-excluir {
    background-color: #f44336;
    color: white;
}

.btn-editar:hover {
    background-color: #45a049;
}

.btn-excluir:hover {
    background-color: #d32f2f;
}

#tabelaFrequencia th:nth-child(5),
#tabelaFrequencia td:nth-child(5) {
    text-align: center;
}

#tabelaFrequencia {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
}

#tabelaFrequencia th, 
#tabelaFrequencia td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: left;
}

#tabelaFrequencia th {
    background-color: #f2f2f2;
    font-weight: bold;
}

#tabelaFrequencia tr:nth-child(even) {
    background-color: #f9f9f9;
}

#tabelaFrequencia tr:hover {
    background-color: #f1f1f1;
}
`;

// Inject additional CSS
const styleElement = document.createElement('style');
styleElement.textContent = additionalCSS;
document.head.appendChild(styleElement);
